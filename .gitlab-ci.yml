image: 'docker:stable'
services:
  - 'docker:dind'
variables:
  IMAGE_NAME: transmission-daemon
  IMAGE_REFERENCE: $CI_PROJECT_NAMESPACE/$IMAGE_NAME
  IMAGE_URL: $CI_REGISTRY/$IMAGE_REFERENCE
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: 'tcp://docker:2375'
before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
build:
  only:
    - master
  stage: build
  script:
    - 'docker pull $IMAGE_URL:latest || true'
    - >-
      docker build --cache-from $IMAGE_REFERENCE:latest --tag
      $IMAGE_REFERENCE:$CI_COMMIT_SHA --tag $IMAGE_REFERENCE:latest .
    - 'docker push $IMAGE_URL:$CI_COMMIT_SHA'
    - 'docker push $IMAGE_URL:latest'
